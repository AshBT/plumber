# Link Plumber [![Build Status](https://travis-ci.org/qadium/plumb.svg)](https://travis-ci.org/qadium/plumb) [![Coverage Status](https://coveralls.io/repos/qadium/plumb/badge.svg)](https://coveralls.io/r/qadium/plumb)
This is the script used to populate our Neo4j backend database.

## Requirements
You can install python requirements via `pip install -r requirements.txt`.
See below for installing Neo4j and opencv.

## Use
This folder uses the following credentials:

1. `ELS_USER` -- the username for the IST elastic search instance
2. `ELS_PASS` -- the password for the IST elastic search instance
3. `NEO_HOST` -- the hostname for the neo4j database, defaults to localhost
4. `NEO_USER` -- the username for the neo4j database
5. `NEO_PASS` -- the password for the neo4j database
6. `SQL_HOST` -- the hostname for the IST memex_ht SQL dump
7. `SQL_USER` -- the username for the SQL dump
8. `SQL_PASS` -- the password for the SQL dump
9. `TWITTER_ACCESS_TOKEN` -- twitter api access token
10. `TWITTER_ACCESS_TOKEN_SECRET` -- twitter api access token secret
11. `TWITTER_CONSUMER_KEY` -- twitter api consumer key
12. `TWITTER_CONSUMER_SECRET` -- twitter consumer secret
13. `YOUTUBE_DEVELOPER_KEY` -- youtube developer key
14. `INSTAGRAM_CLIENT_ID` -- instagram client id
15. `INSTAGRAM_CLIENT_SECRET` -- instagram client secret
17. `INSTAGRAM_ACCESS_TOKEN` -- instagram access token
18. `S3_ACCESS_KEY` -- S3 access key
19. `S3_SECRET_KEY` -- S3 secret key


Running `python ingest.py` should download the ads into neo4j.

For local development and testing, assuming the SQL credentials have
already been provided, the default neo4j database should work with

    NEO_USER=neo4j NEO_PASS=neo4j NEO_HOST=localhost:7474 python ingest.py

This will download a slice of the database to a *local* neo4j server. The
structure of the local copy will be the same as the structure of the graph in
production. You can develop with the local copy with knowledge that your code
will work in production.

## Enhancing
Once we've ingested the memex_ht database into neo4j, we only have the ad records and nothing more. To enhance the data and construct entities, run

    ./enhance -v Attributer Imager BaseCreator ImageLinker Twitter Youtube Instagram FaceFinder TextHash TextHashLinker

This will run the `Attributer`, `Imager`, `BaseCreator`, `ImageLinker`, `Twitter`, `Youtube`, `Instagram`, `FaceFinder`, `TextHash`, `TextHashLinker` enhancers (in that order). The `-v` flag tells the script to be verbose; you can duplicate the flag for more debugging info, for instance: `./enhance -vvv` will show a lot of debugging information.

The `Attributer` adds the extra information from `ads_attributes` from the memex_ht database; the `Imager` adds image information from the `images` table from the memx_ht database; the `BaseCreator` creates base entities by linking together phone numbers; and `Twitter` adds any twitter account data.

You can write your own enhancers by adding them to the plugins directory and, assuming your enhancer's class name is MyEnhancer, run them with

    ./enhance MyEnhancer

To link ads by images, you will need to first run `Imager`, then `ImageLinker`:

    ./enhance -v Imager ImageLinker

You can only run `linkers` after populating the DB with data `enhancers` because the `linkers` link data generated by the `enhancers`.

### Available enhancers
Enhancers are added to the `plugins` folder and made available to the `enhance` script. Running `./enhance -h` will show a list of available enhancers. Note that the enhancer names are *case sensitive*.

## Testing
To ensure that our code works "as intended", we also include a suite of
test cases to check each enhancer (TODO). You can run these with

    make test

If tests fail, then submit a bug report. These tests are meant to only
be run on Qadium's internal network.

### What the tests do
The test first downloads `neo4j-community-2.2.1` and installs it to a
temporary directory, running a fresh copy of it. Unless you run `make clean`, this only needs to be downloaded once.

It then installs a virtualenv and runs `pip install -r requirements.txt`
to ensure that the `requirements.txt` file contains all the dependencies needed to run the enhancers.

Finally, it uses `nose` to run the unit tests under the `tests` directory. If any of these fail, go fix the problem. When new enhancers
are added, new tests must also be added.

## Some useful queries
To get a table that contains the top 10 Entities (as ordered by Ad count) along
with the list of Ads belonging to that Entity, run the following query:
```Cypher
MATCH (n:Entity)-[:BY_PHONE]->(m)
WITH n, collect(distinct m) as ads, count(distinct m) as counts
RETURN n.identifier, ads, counts
ORDER BY counts desc LIMIT 10
```

As new edge labels are added, we can fiddle with the definition of an entity
```Cypher
MATCH (n:Entity)-[:BY_PHONE|BY_IMG]->(m)
WITH n, collect(distinct m) as ads, count(distinct m) as counts
RETURN n.identifier, ads, counts
ORDER BY counts desc LIMIT 10
```
This query defines an entity as one that is linked by phone number and by images. It will collect all the relevant ads and put them in
a list in the second column.

Finally, we can find the top 10 entities by the number of distinct ads in them and display the associated phone numbers:
```Cypher
MATCH (n:Entity)-[:BY_PHONE|BY_IMG]->(m)
UNWIND(m.phone) as numbers
WITH n, collect(distinct numbers) as phones, count(distinct m) as counts
RETURN n.identifier, counts, phones
ORDER BY counts desc LIMIT 10
```

Now suppose we want to find all Entities that contain Ads with Brown eyes,
```Cypher
MATCH (n:Entity)-[:BY_PHONE|BY_IMG]->(m)
WHERE has(m.eyes) and "Brown" in m.eyes
WITH n, collect(distinct m) as ads
RETURN n.identifier, ads LIMIT 10
```

Suppose we want to define an Entity as one that has a minimum image similarity score of less than 0.001
```Cypher
MATCH (n:Entity)-[r:BY_PHONE|BY_IMG]->(m)
WHERE has(r.min_dist) and toFloat(r.min_dist) < 0.001
WITH n, collect(distinct m) as ads
RETURN n.identifier, ads LIMIT 10
```

#Install Neo4j

Install Neo4j using brew

`brew install Neo4j`

Start neo4j

`neo4j start`

Open a browser and go to localhost:7474 to browser Neo4j

##Install OpenCV

`brew install opencv`

`ln -s /usr/local/Cellar/opencv/2.4.11_1/lib/python2.7/site-packages/cv.py /Library/Python/2.7/site-packages/cv.py`

`ln -s /usr/local/Cellar/opencv/2.4.11_1/lib/python2.7/site-packages/cv2.so /Library/Python/2.7/site-packages/cv2.so`
